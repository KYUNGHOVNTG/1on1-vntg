"""개발/테스트용 R&R Mock 데이터 시드

Revision ID: m0n1o2p3q4r5
Revises: l9m0n1o2p3q4
Create Date: 2026-02-24 00:00:00.000000

삽입 데이터:
1. tb_rr_level : 2026년 기준 레벨 6개 (전사~파트)
2. tb_rr       : 계층 구조 샘플 7건
   - LEADER R&R 4건 (EMP006, EMP013, EMP014)
   - MEMBER R&R 3건 (EMP016, EMP017) — 상위 R&R 연결
3. tb_rr_period: 총 10건 (다중 단절 기간 포함)

직원 배치 근거 (j7k8l9m0n1o2 마이그레이션 기준):
  - EMP006 (강동원): DEPT021(개발1팀), P002(총괄) → LEADER
  - EMP013 (배수지): DEPT212(백엔드파트), P003(센터장) → LEADER
  - EMP014 (남주혁): DEPT221(AI파트), P003(센터장) → LEADER
  - EMP016 (유재석): DEPT212(백엔드파트), P004(팀장) → Mock 데이터에서 MEMBER로 삽입 (UI 테스트용)
  - EMP017 (강호동): DEPT221(AI파트), P004(팀장) → Mock 데이터에서 MEMBER로 삽입 (UI 테스트용)

※ EMP016/EMP017은 실제 직책이 P004이나, 현재 시드 데이터에 P005(팀원) 직원이 없으므로
   MEMBER 타입 UI 시나리오 테스트를 위해 mock 데이터에서 MEMBER로 직접 지정

UUID 고정값 (Self-Reference FK를 위해 사전 정의):
  RR_LEADER_001: 11111111-1111-1111-1111-111111111001
  RR_LEADER_002: 11111111-1111-1111-1111-111111111002
  RR_LEADER_003: 11111111-1111-1111-1111-111111111003
  RR_LEADER_004: 11111111-1111-1111-1111-111111111004
  RR_MEMBER_001: 11111111-1111-1111-1111-111111111005
  RR_MEMBER_002: 11111111-1111-1111-1111-111111111006
  RR_MEMBER_003: 11111111-1111-1111-1111-111111111007
"""

from typing import Sequence, Union

from alembic import op

# revision identifiers, used by Alembic.
revision: str = "m0n1o2p3q4r5"
down_revision: Union[str, None] = "l9m0n1o2p3q4"
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """
    R&R Mock 데이터 삽입

    삽입 순서:
    1. tb_rr_level (레벨 마스터)
    2. tb_rr — LEADER 먼저 삽입 (Self-Reference FK 순서)
    3. tb_rr — MEMBER 삽입 (parent_rr_id 참조)
    4. tb_rr_period (기간 데이터)
    """

    # =============================================
    # 1. tb_rr_level — 2026년 기준 레벨 6개
    # =============================================
    op.execute("""
        INSERT INTO tb_rr_level (level_id, year, level_name, level_step)
        VALUES
            ('LV2026_0', '2026', '전사', 0),
            ('LV2026_1', '2026', '부문', 1),
            ('LV2026_2', '2026', '본부', 2),
            ('LV2026_3', '2026', '센터', 3),
            ('LV2026_4', '2026', '팀',   4),
            ('LV2026_5', '2026', '파트', 5)
        ON CONFLICT (level_id) DO NOTHING
    """)

    # =============================================
    # 2. tb_rr — LEADER R&R 4건 (상위 R&R 없음)
    #
    # RR_LEADER_001: EMP006(강동원) / 개발1팀(DEPT021) / 팀 레벨
    # RR_LEADER_002: EMP006(강동원) / 개발1팀(DEPT021) / 팀 레벨
    # RR_LEADER_003: EMP013(배수지) / 백엔드파트(DEPT212) / 파트 레벨
    # RR_LEADER_004: EMP014(남주혁) / AI파트(DEPT221) / 파트 레벨
    # =============================================
    op.execute("""
        INSERT INTO tb_rr
            (rr_id, year, level_id, emp_no, dept_code, rr_type, parent_rr_id,
             title, content, status, in_user, in_date)
        VALUES
            (
                '11111111-1111-1111-1111-111111111001'::uuid,
                '2026', 'LV2026_4', 'EMP006', 'DEPT021', 'LEADER', NULL,
                '개발1팀 기술 역량 강화 및 품질 관리',
                '팀원의 기술 역량 향상을 위한 교육 계획 수립 및 실행.'
                || E'\\n' || '코드 리뷰 프로세스 정착을 통한 코드 품질 기준 유지.'
                || E'\\n' || '분기별 기술 세미나 및 스터디 그룹 운영.',
                'R', 'system', '2026-01-02 09:00:00'
            ),
            (
                '11111111-1111-1111-1111-111111111002'::uuid,
                '2026', 'LV2026_4', 'EMP006', 'DEPT021', 'LEADER', NULL,
                '신규 서비스 아키텍처 설계 및 기술 로드맵 수립',
                '상반기 신규 서비스 출시를 위한 시스템 아키텍처 설계.'
                || E'\\n' || '마이크로서비스 전환 가능성 검토 및 PoC 수행.'
                || E'\\n' || '연간 기술 로드맵 수립 및 이해관계자 보고.',
                'R', 'system', '2026-01-02 09:10:00'
            ),
            (
                '11111111-1111-1111-1111-111111111003'::uuid,
                '2026', 'LV2026_5', 'EMP013', 'DEPT212', 'LEADER', NULL,
                '백엔드파트 운영 및 기술 표준화',
                '백엔드 개발 표준(코딩 컨벤션, API 설계 원칙) 수립 및 준수.'
                || E'\\n' || 'FastAPI + SQLAlchemy 기반 공통 모듈 개발 및 유지보수.'
                || E'\\n' || '파트 내 온보딩 프로세스 개선 및 문서화.',
                'R', 'system', '2026-01-03 09:00:00'
            ),
            (
                '11111111-1111-1111-1111-111111111004'::uuid,
                '2026', 'LV2026_5', 'EMP014', 'DEPT221', 'LEADER', NULL,
                'AI파트 AI 기술 연구 및 모델 개발',
                'LLM 기반 서비스 품질 개선을 위한 파인튜닝 연구 수행.'
                || E'\\n' || '사내 AI 활용 가이드라인 수립 및 교육.'
                || E'\\n' || 'AI 모델 성능 지표(정확도, 지연시간) 목표 관리.',
                'R', 'system', '2026-01-03 09:10:00'
            )
        ON CONFLICT (rr_id) DO NOTHING
    """)

    # =============================================
    # 3. tb_rr — MEMBER R&R 3건 (상위 R&R 참조)
    #
    # RR_MEMBER_001: EMP016(유재석) / DEPT212 / parent=RR_LEADER_003
    # RR_MEMBER_002: EMP016(유재석) / DEPT212 / parent=RR_LEADER_003
    # RR_MEMBER_003: EMP017(강호동) / DEPT221 / parent=RR_LEADER_004
    # =============================================
    op.execute("""
        INSERT INTO tb_rr
            (rr_id, year, level_id, emp_no, dept_code, rr_type, parent_rr_id,
             title, content, status, in_user, in_date)
        VALUES
            (
                '11111111-1111-1111-1111-111111111005'::uuid,
                '2026', 'LV2026_5', 'EMP016', 'DEPT212', 'MEMBER',
                '11111111-1111-1111-1111-111111111003'::uuid,
                '백엔드 API 개발 및 코드 리뷰',
                '도메인별 RESTful API 설계 및 구현 (FastAPI 기반).'
                || E'\\n' || '팀 내 코드 리뷰 적극 참여 및 리뷰어 역할 수행.'
                || E'\\n' || '단위 테스트 커버리지 80% 이상 유지.',
                'R', 'system', '2026-01-06 10:00:00'
            ),
            (
                '11111111-1111-1111-1111-111111111006'::uuid,
                '2026', 'LV2026_5', 'EMP016', 'DEPT212', 'MEMBER',
                '11111111-1111-1111-1111-111111111003'::uuid,
                '데이터베이스 성능 최적화 및 쿼리 개선',
                '슬로우 쿼리 분석 및 인덱스 최적화 작업.'
                || E'\\n' || 'ORM 쿼리 N+1 문제 점검 및 개선.'
                || E'\\n' || '월별 DB 성능 리포트 작성 및 공유.',
                'N', 'system', '2026-01-06 10:30:00'
            ),
            (
                '11111111-1111-1111-1111-111111111007'::uuid,
                '2026', 'LV2026_5', 'EMP017', 'DEPT221', 'MEMBER',
                '11111111-1111-1111-1111-111111111004'::uuid,
                'AI 모델 학습 파이프라인 구축',
                '데이터 수집부터 모델 배포까지의 MLOps 파이프라인 설계.'
                || E'\\n' || '실험 추적(MLflow) 환경 구성 및 모델 버전 관리.'
                || E'\\n' || '학습 자동화 스크립트 개발 및 GPU 리소스 최적화.',
                'R', 'system', '2026-01-07 09:00:00'
            )
        ON CONFLICT (rr_id) DO NOTHING
    """)

    # =============================================
    # 4. tb_rr_period — 총 10건
    #
    # RR_LEADER_001: seq=1, 202601~202612 (연간)
    # RR_LEADER_002: seq=1, 202601~202606 (상반기)
    # RR_LEADER_003: seq=1, 202601~202612 (연간)
    # RR_LEADER_004: seq=1, 202601~202612 (연간)
    # RR_MEMBER_001: seq=1, 202601~202603 / seq=2, 202607~202612 (단절 기간 — UI 테스트용)
    # RR_MEMBER_002: seq=1, 202604~202606 (단기)
    # RR_MEMBER_003: seq=1, 202601~202612 (연간)
    # =============================================
    op.execute("""
        INSERT INTO tb_rr_period (rr_id, seq, start_date, end_date)
        VALUES
            -- RR_LEADER_001 (개발1팀 기술 역량 강화): 연간
            ('11111111-1111-1111-1111-111111111001'::uuid, 1, '202601', '202612'),

            -- RR_LEADER_002 (신규 서비스 아키텍처): 상반기
            ('11111111-1111-1111-1111-111111111002'::uuid, 1, '202601', '202606'),

            -- RR_LEADER_003 (백엔드파트 운영): 연간
            ('11111111-1111-1111-1111-111111111003'::uuid, 1, '202601', '202612'),

            -- RR_LEADER_004 (AI 기술 연구): 연간
            ('11111111-1111-1111-1111-111111111004'::uuid, 1, '202601', '202612'),

            -- RR_MEMBER_001 (백엔드 API 개발): 단절 기간 (1~3월 + 7~12월) — 타임라인 바 다중 구간 테스트
            ('11111111-1111-1111-1111-111111111005'::uuid, 1, '202601', '202603'),
            ('11111111-1111-1111-1111-111111111005'::uuid, 2, '202607', '202612'),

            -- RR_MEMBER_002 (DB 성능 최적화): 단기 (4~6월)
            ('11111111-1111-1111-1111-111111111006'::uuid, 1, '202604', '202606'),

            -- RR_MEMBER_003 (AI 모델 파이프라인): 연간
            ('11111111-1111-1111-1111-111111111007'::uuid, 1, '202601', '202612')
        ON CONFLICT (rr_id, seq) DO NOTHING
    """)


def downgrade() -> None:
    """
    Mock 데이터 전체 삭제 (역순: period → rr → rr_level)
    """

    # =============================================
    # 1. tb_rr_period: tb_rr FK 참조 → 먼저 삭제
    #    (ON DELETE CASCADE이지만 명시적으로 삭제)
    # =============================================
    op.execute("""
        DELETE FROM tb_rr_period
        WHERE rr_id IN (
            '11111111-1111-1111-1111-111111111001'::uuid,
            '11111111-1111-1111-1111-111111111002'::uuid,
            '11111111-1111-1111-1111-111111111003'::uuid,
            '11111111-1111-1111-1111-111111111004'::uuid,
            '11111111-1111-1111-1111-111111111005'::uuid,
            '11111111-1111-1111-1111-111111111006'::uuid,
            '11111111-1111-1111-1111-111111111007'::uuid
        )
    """)

    # =============================================
    # 2. tb_rr: MEMBER 먼저 삭제 (Self-Reference FK)
    # =============================================
    op.execute("""
        DELETE FROM tb_rr
        WHERE rr_id IN (
            '11111111-1111-1111-1111-111111111005'::uuid,
            '11111111-1111-1111-1111-111111111006'::uuid,
            '11111111-1111-1111-1111-111111111007'::uuid
        )
    """)

    # =============================================
    # 3. tb_rr: LEADER 삭제
    # =============================================
    op.execute("""
        DELETE FROM tb_rr
        WHERE rr_id IN (
            '11111111-1111-1111-1111-111111111001'::uuid,
            '11111111-1111-1111-1111-111111111002'::uuid,
            '11111111-1111-1111-1111-111111111003'::uuid,
            '11111111-1111-1111-1111-111111111004'::uuid
        )
    """)

    # =============================================
    # 4. tb_rr_level: 2026년 레벨 데이터 삭제
    # =============================================
    op.execute("""
        DELETE FROM tb_rr_level
        WHERE level_id IN (
            'LV2026_0', 'LV2026_1', 'LV2026_2',
            'LV2026_3', 'LV2026_4', 'LV2026_5'
        )
    """)
